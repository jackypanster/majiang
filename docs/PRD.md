# 血战到底麻将 - 后端服务产品需求文档 (PRD)

## 1. 概述

### 1.1. 项目目标
本项目旨在为“血战到底”麻将游戏构建一个稳定、高效且模块化的后端服务。该服务将独立处理所有游戏核心逻辑，包括规则判断、状态管理、计分结算等，并通过一组清晰的API接口与前端或其他客户端进行交互。

### 1.2. 核心特点
- **血战到底模式**：支持一家胡牌后牌局继续，直至三家胡牌或流局。
- **定缺埋牌**：开局时玩家需选择一门花色作为缺门，并埋下三张同花色的牌。
- **结构化胡牌**：胡牌牌型统一为“一对将 + 三个面子”，移除了七对等特殊牌型，规则更清晰。
- **精简规则**：移除了“抢杠胡”、“过手杠”等复杂特殊规则，简化了游戏逻辑。
- **事件驱动**：游戏流程由玩家动作事件驱动，保证了响应的及时性和逻辑的严密性。
- **模块化API**：后端功能将通过模块化的接口提供，便于前端接入和未来扩展。

---

## 2. 核心游戏规则

这是后端逻辑必须严格遵守的规则集，是所有算法实现的基础。

### 2.1. 游戏准备
- **玩家人数**：4人。
- **牌库**：使用筒、条、万三种花色，每种1-9各4张，共108张牌。
- **发牌**：庄家起手14张，闲家13张。

### 2.2. 定缺埋牌
- **动作**：发牌后，每位玩家必须从手牌中选择三张同花色的牌进行“埋牌”。
- **效果**：
  - 埋下的牌亮明缺门，但不参与后续牌局。
  - 埋牌后，庄家手牌变为11张，闲家变为10张。
  - 玩家在后续出牌时，必须优先打完缺门花色的牌。

### 2.3. 游戏流程
- **禁止吃牌**：不允许“吃”操作。
- **碰牌**：任意玩家打出的牌，如有玩家手中有两张相同的牌，可碰。
- **杠牌**：
  - **明杠**：手中有三张相同牌，他人打出第四张时可杠。点杠者向杠牌者支付2倍底分。
  - **暗杠**：手中有四张相同牌，可声明杠牌。其他三家向杠牌者各支付1倍底分。
  - **补杠**：已碰牌后，自己摸到第四张相同的牌，可杠。其他三家向杠牌者各支付1倍底分。
- **血战模式**：有玩家胡牌后，该玩家结束游戏，牌局继续。直到有三家胡牌或牌墙摸完（流局）。

### 2.4. 胡牌条件
- **缺门**：胡牌时，玩家的手牌和明牌中不能包含自己已定缺的花色。
- **牌型结构**：胡牌牌型必须由 **“一对将”** 和 **“三个面子”** 组成。
  - **将**：两张相同的牌。
  - **面子**：可以是“顺子”（三张连续的牌）、“刻子”（三张相同的牌）或“杠”（四张相同的牌）。
- **总张数**：根据牌型中是否包含“杠”，胡牌时的总张数是可变的（例如，无杠为11张，一个杠为12张）。

### 2.5. 计分规则
- **基础番数**：胡牌的基础番数由牌型决定，可叠加计算。
- **计分公式**：`得分 = 底分 * 2^总番数`。
- **主要番型**：
| 牌型名称 | 番数 | 描述 |
|---|---|---|
| 基本胡 | 0 | 满足胡牌条件的最小牌型 |
| 门清 | +1 | 没有碰、明杠行为 |
| 自摸 | +1 | 自己摸牌胡 |
| 带根（每根）| +1 | 牌型中有一个4张的杠或刻子 |
| 对对胡 | 1-2 | 由三个刻子/杠子组成的胡牌 |
| 清一色 | 2 | 所有牌为同一花色 |
| ... | ... | （其他番型见规则文档） |
- **杠分结算**：所有杠分在发生时即时结算（“刮风下雨”）。

### 2.6. 流局
- **条件**：牌墙所有牌被摸完，但胡牌玩家不足三家。
- **处理**：
  1. **查花猪**：检查未胡牌玩家手牌，如有三色牌，则为“花猪”，进行罚分。
  2. **查大叫**：检查未胡牌且非花猪的玩家是否听牌，未听牌者向听牌者赔付。
  3. **退杠分**：未听牌者此前赢得的杠分需退回。

---

## 3. 模块化接口设计 (API)

后端服务应至少包含以下两大核心模块，并通过API暴露其功能。

### 3.1. 游戏管理模块 (`GameManager`)
负责管理一整局游戏的生命周期。
- `create_game(players)`: 创建一个新游戏，初始化牌墙、玩家等。
- `start_game()`: 宣布游戏开始，进入发牌和定缺阶段。
- `get_game_state(player_id)`: 获取当前游戏状态。为保证信息安全，应根据`player_id`过滤信息，例如只向该玩家展示其手牌。
- `end_game()`: 游戏结束，进行最终结算。

### 3.2. 玩家动作模块 (`PlayerActions`)
负责处理来自玩家的每一个具体操作。
- `bury_cards(player_id, tiles)`: 处理玩家的埋牌定缺操作。
- `discard_tile(player_id, tile)`: 处理玩家的出牌操作。
- `declare_action(player_id, action_type, target_tile)`: 处理玩家针对其他玩家出牌的响应，如 `action_type` 可以是 `PONG`, `KONG`, `HU`, `PASS`。

---

## 4. 核心数据结构

API交互中需要用到的主要数据对象。

- **`GameState`**: 描述游戏全局状态。
  - `game_id`: 游戏唯一标识。
  - `players`: 玩家列表。
  - `current_player_index`: 当前轮到哪个玩家操作。
  - `wall_remaining_count`: 牌墙剩余张数。
  - `public_discards`: 公共弃牌堆。
  - `game_phase`: 游戏当前阶段（如 `BURYING`, `PLAYING`, `ENDED`）。

- **`Player`**: 描述单个玩家的状态。
  - `player_id`: 玩家唯一标识。
  - `hand`: 手牌列表（对其他玩家不可见）。
  - `melds`: 碰或杠的明牌。
  - `buried_cards`: 埋下的三张牌。
  - `missing_suit`: 缺门花色。
  - `score`: 当前积分。
  - `is_hu`: 是否已胡牌。

- **`Tile`**: 描述一张麻将牌。
  - `suit`: 花色（筒、条、万）。
  - `rank`: 点数（1-9）。

---

## 5. 暂不实现 (Out of Scope)

为保证项目初期聚焦核心逻辑，以下功能暂不实现：
- **AI 玩家**：后端只处理规则，不实现电脑玩家。
- **用户认证与账户系统**：玩家通过临时`player_id`加入游戏。
- **数据持久化**：游戏状态仅在内存中管理，服务重启后游戏消失。
- **前端UI**：本项目只负责后端逻辑。
