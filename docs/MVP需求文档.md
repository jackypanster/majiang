# 血战到底麻将 MVP 需求文档

## 文档版本
- **版本号**: v1.0
- **创建日期**: 2025-11-05
- **最后更新**: 2025-11-05

---

## 1. MVP 概述

### 1.1 产品定位
本 MVP（最小可行产品）旨在构建一个**单机版、单人对战3个AI的血战到底麻将游戏**，采用前后端分离架构，验证核心游戏玩法和技术方案的可行性。

### 1.2 核心目标
- ✅ **验证核心玩法**：完整的麻将游戏流程（发牌→定缺→出牌→碰/杠→胡牌）
- ✅ **验证技术架构**：前后端分离、RESTful API通信、Canvas渲染
- ✅ **快速迭代**：简化功能，专注核心体验，为后续扩展打好基础

### 1.3 非目标（暂不实现）
- ❌ 多人在线对战
- ✅ 血战到底模式（已实现简化版：多次胡牌，牌墙摸完才结束）
- ✅ 复杂番型计算（已实现：门清、对对胡、清一色等）
- ❌ 补杠、抢杠胡等高级规则
- ❌ 动画特效、音效音乐
- ❌ 用户账户系统、数据持久化

---

## 2. 功能需求

### 2.1 游戏初始化

#### 功能描述
创建一个新游戏，完成洗牌、发牌、确定庄家。

#### 用户故事
> 作为玩家，我打开游戏后，点击"开始游戏"，系统自动分配我和3个AI玩家，完成发牌。

#### 验收标准
- [x] 玩家固定为0号位（东位）
- [x] 玩家为庄家，起手14张牌
- [x] 3个AI玩家（1号、2号、3号）各13张牌
- [x] 使用筒、条、万三种花色，每种1-9各4张，共108张牌
- [x] 发牌后剩余55张牌进入牌墙

#### 技术细节
- 后端生成唯一 `gameId`
- 前端通过 `POST /api/game/create` 创建游戏
- 返回初始游戏状态

---

### 2.2 定缺埋牌

#### 功能描述
游戏开始后，玩家和AI各自选择3张同花色的牌埋掉，确定缺门。

#### 用户故事
> 作为玩家，发牌后我需要从手牌中选择3张同花色的牌进行埋牌，系统提示我选择的花色将成为我的缺门。

#### 验收标准
- [x] 玩家可以查看手牌，按花色分组显示
- [x] 玩家选择3张同一花色的牌（点击选中/取消，视觉高亮）
- [x] 选择满3张且同花色后，"确认埋牌"按钮可用
- [x] 提交后，埋牌从手牌移除（玩家剩11张，AI剩10张）
- [x] 系统记录玩家的缺门花色（`missing_suit`）
- [x] AI自动完成埋牌（简单策略：选择手牌中数量最少的花色）
- [x] 埋牌后进入出牌阶段

#### 异常处理
- 选择的3张牌不是同花色 → 前端禁用"确认"按钮
- 手牌中某花色不足3张 → 不允许选择该花色（前端提示）

---

### 2.3 基本出牌与摸牌

#### 功能描述
玩家和AI轮流摸牌、出牌，遵循麻将基本规则。

#### 用户故事
> 作为玩家，轮到我时，我先摸一张牌，然后从手牌中选择一张牌打出。

#### 验收标准

**摸牌**
- [x] 轮到玩家时，自动从牌墙摸一张牌，加入手牌
- [x] 手牌自动排序（按花色、点数）
- [x] 显示牌墙剩余张数

**出牌**
- [x] 玩家点击手牌中的一张牌，打出到弃牌堆
- [x] 遵守定缺规则：手牌中有缺门牌时，必须优先打缺门牌
- [x] 打出的牌显示在公共弃牌区域
- [x] 出牌后，轮到下家（AI玩家1）

**AI出牌**
- [x] AI自动摸牌、出牌（简单策略：优先打缺门牌 → 孤张 → 边张）
- [x] 前端轮询获取游戏状态，展示AI的出牌动作
- [x] AI出牌有适当延迟（300-500ms），提升真实感

#### 异常处理
- 玩家尝试出非缺门牌，但手中有缺门牌 → 前端禁用点击，提示"请先打缺门牌"
- 牌墙已空 → 游戏结束，显示最终积分

---

### 2.4 碰牌

#### 功能描述
当其他玩家打出一张牌时，如果玩家手中有两张相同的牌，可以选择碰牌。

#### 用户故事
> 作为玩家，当AI打出一张牌，我手中有两张相同的牌时，系统弹出"碰"按钮，我可以选择碰或过。

#### 验收标准
- [x] AI或其他玩家打出牌后，系统检测玩家是否可碰
- [x] 可碰时，弹出操作按钮：[碰] [过]
- [x] 玩家点击"碰"：
  - 从手牌移除2张相同牌
  - 加上打出的牌，组成明牌组（3张）
  - 玩家获得出牌权，轮到玩家出牌
- [x] 玩家点击"过"：继续正常流程

**AI碰牌**
- [x] AI简单策略：如果碰牌后能听牌或接近听牌，则碰；否则过
- [x] MVP简化：AI随机决定（50%概率碰）

#### 异常处理
- 玩家碰牌后，必须从手牌中出一张牌（不能再摸牌）

---

### 2.5 杠牌（明杠、暗杠）

#### 功能描述
玩家可以进行明杠（他人打出第四张）或暗杠（自己手中有四张）。

#### 用户故事
> 作为玩家，当我手中有4张相同的牌时，我可以选择暗杠；当AI打出的牌我已有3张时，我可以选择明杠。

#### 验收标准

**明杠**
- [x] AI打出牌后，检测玩家手中是否有3张相同牌
- [x] 弹出操作按钮：[杠] [碰] [过]（优先级：杠 > 碰）
- [x] 玩家点击"杠"：
  - 从手牌移除3张
  - 组成明杠（4张明牌）
  - 从牌墙补摸一张牌
  - 玩家获得出牌权

**暗杠**
- [x] 轮到玩家，摸牌后，检测手牌是否有4张相同牌
- [x] 显示"杠"按钮（可选操作）
- [x] 玩家点击"杠"：
  - 从手牌移除4张
  - 组成暗杠（4张牌，背面朝上，表示暗杠）
  - 从牌墙补摸一张牌
  - 继续出牌

**AI杠牌**
- [x] AI简单策略：优先暗杠，明杠根据手牌情况决定
- [x] MVP简化：AI有杠就杠

#### 异常处理
- 牌墙最后一张牌不允许杠（只能碰）

#### 暂不实现
- ❌ 补杠（已碰牌后，再摸到第四张）
- ❌ 抢杠胡

---

### 2.6 胡牌判断

#### 功能描述
判断玩家或AI是否满足胡牌条件（缺一门 + 基本牌型）。

#### 用户故事
> 作为玩家，当我的手牌满足胡牌条件时（缺门 + 一对将 + 三组面子），我可以选择胡牌。

#### 验收标准

**胡牌条件**
- [x] 手牌和明牌中**不包含缺门花色**
- [x] 牌型结构：**一对将（两张相同）+ 三组面子**
  - 面子：顺子（123）、刻子（111）、杠（1111）
- [x] 根据面子类型，总张数可变：
  - 无杠：11张（2+3+3+3）
  - 一杠：12张（2+3+3+4）
  - 以此类推

**自摸胡**
- [x] 玩家摸牌后，系统自动检测是否可胡
- [x] 可胡时，弹出"胡牌"按钮
- [x] 玩家点击"胡牌" → 游戏结束，进入结算

**点炮胡**
- [x] AI打出牌后，检测玩家是否可用该牌胡
- [x] 弹出操作按钮：[胡] [杠] [碰] [过]（优先级：胡 > 杠 > 碰）
- [x] 玩家点击"胡" → 游戏结束，进入结算

**AI胡牌**
- [x] AI能胡就胡（自摸或点炮）
- [x] 前端展示"AI玩家X胡牌"提示

#### MVP简化（已升级）
- ✅ 完整番型计算（门清、自摸、带根、对对胡、清一色等）
- ✅ 血战到底模式：**多次胡牌，牌墙摸完才结束**

---

### 2.7 简单计分与结算

#### 功能描述
游戏结束后，显示胜负结果和简单积分。

#### 用户故事
> 作为玩家，胡牌后我看到结算界面，显示我赢了，获得了多少分。

#### 验收标准
- [x] 胡牌后，弹出结算界面
- [x] 显示胡牌者、胡牌类型（自摸/点炮）
- [x] 简单计分规则：
  - 自摸：其他三家各支付**固定底分10分**
  - 点炮：点炮者支付**固定底分10分**
- [x] 显示各玩家最终积分变化
- [x] 提供"再来一局"按钮（重新创建游戏）

#### MVP简化（已升级）
- ✅ 完整番型计算（得分 = 番数）
- ✅ 杠分即时结算（刮风下雨）
- ✅ 多种番型加成（门清、对对胡、清一色等）

---

### 2.8 游戏结束处理

#### 功能描述
牌墙摸完时游戏结束，显示最终积分。

#### 验收标准
- [x] 牌墙剩余0张时，游戏结束
- [x] 显示最终结算界面，展示所有玩家的得分
- [x] MVP简化：直接结束游戏，不查花猪、不查大叫、不退杠分
- [x] 提供"再来一局"按钮

#### 暂不实现
- ❌ 查花猪（三色牌扣分）
- ❌ 查大叫（听牌检测）
- ❌ 退杠分

---

## 3. 非功能需求

### 3.1 性能要求
- 前端渲染流畅（60fps），Canvas绘制麻将牌无卡顿
- API响应时间 < 200ms（本地环境）
- AI决策时间 < 500ms（含人为延迟）

### 3.2 兼容性要求
- 支持现代浏览器（Chrome、Firefox、Edge、Safari 最新版）
- 不考虑移动端（MVP阶段仅桌面浏览器）

### 3.3 可用性要求
- 界面简洁直观，无需教程即可上手
- 关键操作有明确提示（如"请先打缺门牌"）
- 非法操作被禁用或置灰（前端校验）

### 3.4 可维护性要求
- 代码结构清晰，前后端分离
- API接口文档完整
- 类型安全（TypeScript + Python类型提示）

---

## 4. 开发优先级

### Phase 1：核心流程（P0，必须实现）
**目标**：能完整走完一局游戏
- ✅ 游戏初始化、发牌
- ✅ 定缺埋牌（玩家手动、AI自动）
- ✅ 基本出牌、摸牌
- ✅ AI简单出牌逻辑
- ✅ 前端轮询状态更新

**验收标准**：玩家可以和AI完整打完一局（即使没有碰/杠/胡）

---

### Phase 2：核心互动（P0，必须实现）
**目标**：有真实麻将互动体验
- ✅ 碰牌功能（玩家+AI）
- ✅ 明杠、暗杠功能
- ✅ 操作按钮UI（碰/杠/过）
- ✅ 前端控制AI回合节奏

**验收标准**：玩家可以碰牌、杠牌，AI也会响应

---

### Phase 3：胜负判定（P0，必须实现）
**目标**：完整的游戏闭环
- ✅ 胡牌判断算法（基本牌型）
- ✅ 自摸、点炮检测
- ✅ 简单计分结算
- ✅ 结算界面
- ✅ 游戏结束处理

**验收标准**：玩家可以胡牌，看到结算结果，开始新一局

---

### Phase 4：体验优化（P1，可选）
**目标**：提升用户体验
- 🔲 AI出牌动画过渡
- 🔲 操作提示音效（点击、碰牌、胡牌）
- 🔲 背景音乐
- 🔲 调试模式（显示AI手牌）
- 🔲 游戏日志（查看历史操作）

---

## 5. 用户界面需求

### 5.1 整体布局
```
┌───────────────────────────────────────────┐
│          AI玩家2 (上家/对家)               │
│       [牌背] [牌背] ... [明牌碰/杠]        │
├───────────────────────────────────────────┤
│ AI玩家3  │                        │ AI玩家1│
│ (左手边) │    弃牌堆中央展示区     │(右手边)│
│ [竖牌]   │   🀇 🀈 🀉 🀊 🀋 ...    │ [竖牌] │
│ [明牌]   │                        │ [明牌] │
├───────────────────────────────────────────┤
│         【操作按钮区域】                   │
│    [碰]  [杠]  [胡]  [过]  (按需显示)     │
├───────────────────────────────────────────┤
│       玩家手牌（当前玩家，0号位）          │
│  [🀇1万] [🀈2万] [🀉3万] ... [🀫9条]      │
│                                           │
│  积分: 100  |  缺门: 🚫筒  |  牌墙: 45张   │
└───────────────────────────────────────────┘
```

### 5.2 UI元素规范

**麻将牌**
- 尺寸：玩家手牌 60x80px，AI手牌 40x55px
- 使用Canvas绘制或精灵图
- 玩家手牌显示花色点数，AI手牌显示牌背
- 明牌（碰/杠）单独区域显示

**操作按钮**
- 尺寸：100x40px
- 状态：可用（绿色）、禁用（灰色）
- 按需显示（无可用操作时隐藏）

**弃牌堆**
- 按出牌顺序排列
- 最新打出的牌高亮显示（3秒后恢复）

**状态信息**
- 玩家积分、缺门、牌墙剩余
- 当前回合提示："轮到你了" / "AI玩家X思考中..."

### 5.3 交互规范

**选牌**
- 鼠标悬停：牌上移10px，显示阴影
- 点击选中：牌上移20px，边框高亮
- 再次点击：取消选中

**埋牌阶段**
- 手牌按花色分组显示（筒 | 条 | 万）
- 已选中的牌数量提示："已选 2/3 张"
- 同花色检测：不符合规则时提示错误

**操作按钮**
- 倒计时：15秒自动选择"过"（可选）
- 快捷键：K=碰，G=杠，H=胡，P=过

---

## 6. 风险与限制

### 6.1 技术风险
- **Canvas性能**：大量麻将牌渲染可能影响性能 → 使用离屏Canvas缓存
- **API轮询频率**：过高可能造成后端压力 → 控制在每秒2-3次
- **前后端状态同步**：轮询可能丢失中间状态 → 后端提供完整历史记录

### 6.2 业务风险
- **AI太弱**：玩家体验差 → Phase 4优化AI策略
- **规则理解偏差**：MVP简化规则可能与玩家预期不符 → 明确文档说明

### 6.3 MVP限制声明
本MVP为技术验证版本，以下功能暂不支持：
- ✅ 血战到底模式（已实现简化版：多次胡牌，牌墙摸完才结束）
- ✅ 复杂番型计算（已实现）
- ✅ 天胡、地胡、杠上花等特殊胡（已实现）
- 补杠、抢杠胡
- 流局时的花猪/大叫判定
- 换庄规则
- 多人对战
- 数据持久化、历史记录

---

## 7. 验收标准总结

### 7.1 功能完整性
- [x] 能创建游戏并发牌
- [x] 能完成定缺埋牌
- [x] 能完整打完一局（出牌/摸牌）
- [x] 能碰牌、杠牌
- [x] 能检测胡牌（自摸/点炮）
- [x] 能显示结算结果
- [x] 能开始新一局

### 7.2 技术质量
- [x] 前后端分离，API通信正常
- [x] 前端TypeScript无编译错误
- [x] Canvas渲染流畅（60fps）
- [x] AI决策合理（不傻瓜）
- [x] 无明显bug（不崩溃、不卡死）

### 7.3 用户体验
- [x] 界面简洁，操作直观
- [x] 关键操作有提示
- [x] 非法操作被阻止
- [x] 游戏节奏合理（不过快/过慢）

---

## 8. 后续迭代方向（v2.0+）

- ✅ 血战到底模式（已实现简化版：多次胡牌，牌墙摸完才结束）
- ✅ 完整番型计算（已实现：门清、对对胡、清一色等）
- 补杠、抢杠胡
- 流局完整处理（花猪、大叫、退杠分）
- 多种AI难度
- 美化UI、动画特效、音效
- 游戏录像回放
- 多人在线对战
- 排行榜、成就系统

---

## 9. 附录

### 9.1 术语表
| 术语 | 解释 |
|------|------|
| 庄家 | 初始多摸一张牌的玩家（本MVP固定为玩家） |
| 定缺 | 选择一门花色作为缺门，胡牌时不能有该花色 |
| 埋牌 | 发牌后选择3张同花色牌移除，定缺的证明 |
| 面子 | 顺子（123）、刻子（111）或杠（1111） |
| 将 | 一对相同的牌（11） |
| 明牌 | 碰或杠后亮出的牌组 |
| 弃牌堆 | 所有玩家打出的牌的集合 |
| 自摸 | 自己摸牌胡 |
| 点炮 | 打出的牌让别人胡 |

### 9.2 参考文档
- [血战到底麻将规则.md](./血战到底麻将规则.md)
- [血战到底麻将游戏算法逻辑实现原理.md](./血战到底麻将游戏算法逻辑实现原理.md)
- [PRD.md](./PRD.md)

---

**文档结束**
