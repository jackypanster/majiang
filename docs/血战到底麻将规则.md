# 血战到底麻将规则（埋三张定缺简化版）

## 1. 概述
- 本规则针对项目中的单局血战到底麻将后端实现：默认 4 人对局，其中 1 名真人玩家对战 3 名 AI。AI 即时响应，真人玩家可以自由思考。
- 牌局仅在牌墙被摸完时结束。途中任意玩家胡牌后，仍可在后续回合继续宣胡。
- 规则聚焦"埋三张定缺 + 番数即得分"的精简体验，移除了抢杠胡、查花猪、查大叫等繁琐流程。

## 2. 用牌与起手
- 使用筒、条、万三门花色，点数 1–9，各 4 张，共 108 张牌。
- 发牌顺序：庄家起手 14 张，闲家起手 13 张。
- 手牌按花色、点数排序仅用于显示，游戏逻辑按多重计数（suit, rank）处理。

## 3. 定缺埋牌
1. 发牌后，每位玩家从手中选择 3 张同一花色的牌置于埋牌区（面朝下）。
2. 埋下的花色即为缺门，后续胡牌时禁止出现该花色。
3. 执行埋牌后，庄家暗牌数量为 11 张，闲家为 10 张。埋牌不回收至牌墙。
4. 手牌中若仍有缺门花色，玩家在出牌时必须优先打完这些牌。

## 4. 回合流程
- **出牌顺序**：庄家先出 1 张牌；之后循环执行“下家摸 1 张牌 → 出 1 张牌”。
- **禁止吃牌**：不允许使用他家弃牌组成顺子。
- **碰牌**：若手牌中有两张相同牌，可对他人刚打出的同牌宣告碰。执行后合并为明牌，手牌减去对应两张。
- **杠牌**：
  - **明杠（KONG_EXPOSED）**：手牌中已有三张，另一玩家打出第四张时宣杠，点杠者支付 2 分。
  - **暗杠（KONG_CONCEALED）**：手牌中四张相同牌，自摸宣杠，其他三家各支付 1 分。
  - **补杠（KONG_UPGRADE）**：已碰的牌再次自摸第四张时补杠，其他三家各支付 1 分。
  - 杠后立即从牌墙补摸 1 张，计入"杠上花/杠上炮"判定。
  - **杠牌的本质（重要！）**：
    - 在**胡牌判定**上，杠（4张）= 刻子（3张），都是一个面子
    - 例如：`11 + 2222 + 3333 + 4444` 等价于 `11 + 222 + 333 + 444`（一对将 + 三个面子）
    - **第4张牌不影响牌型结构**，只影响番数（带根，每根+1番）
    - 杠操作的实际作用：①即时得分（刮风下雨）②补摸牌（可能杠上花）③战术价值
- **真人节奏**：后端不设置等待计时或超时处理，真人玩家可自由决定出牌节奏。
- **AI 响应**：AI 在收到弃牌或系统事件时立即返回决策，系统再按优先级裁定。

## 4.5 碰/杠/胡后的操作流程

本节明确说明碰牌、杠牌、胡牌后的具体操作，包括是否摸牌、是否打牌、回合如何变化。

### 4.5.1 碰牌后

**操作流程**：
1. 宣告碰牌后，从手牌中移除2张相同的牌
2. 加上别人打出的1张，形成3张明牌
3. **不摸牌**
4. **回合切换到碰牌者**
5. **必须立即打出一张手牌**

**要点**：
- 碰牌后不摸牌，直接打牌，因此手牌数量会减少
- 例如：闲家碰牌前有10张暗牌，碰牌后剩8张，打出1张后剩7张（+ 1组3张明牌）

---

### 4.5.2 杠牌后

**明杠（别人打出的牌）**：
1. 从手牌中移除3张相同的牌
2. 加上别人打出的1张，形成4张明牌
3. **立即从牌墙末尾补摸1张牌**
4. **刮风下雨即时结算**：打牌者扣2分，杠牌者加2分
5. **回合切换到杠牌者**
6. 检查是否"杠上花"（自摸），若是则直接胡牌
7. 否则**必须打出一张手牌**

**暗杠（自己手里4张）**：
1. 从手牌中移除4张相同的牌，形成4张明牌
2. **立即从牌墙末尾补摸1张牌**
3. **刮风下雨即时结算**：其他三家各扣1分，杠牌者加3分
4. **回合保持不变（还是自己）**
5. 检查是否"杠上花"，若是则直接胡牌
6. 否则**必须打出一张手牌**

**要点**：
- 杠牌必定补摸1张，确保有牌可打
- 杠分即时结算，不等到游戏结束
- 杠上花指补摸的牌恰好可以胡牌，此时不再打牌，直接胡牌

---

### 4.5.3 胡牌后

**点炮胡（别人打出的牌）**：
1. 验证可以胡牌（符合缺门要求和牌型结构）
2. 计算番数并即时结算：点炮者扣分，胡牌者加分
3. 胡的牌加入"已胡牌"记录（用于显示）
4. 玩家标记为"已胡"状态
5. **不打牌，回合直接结束**
6. **轮到打牌者的下一个玩家**

**自摸胡（自己摸到的牌）**：
1. 验证可以胡牌
2. 计算番数（含"自摸"+1番）并即时结算：其他三家各扣分，胡牌者加分
3. 摸到的牌加入"已胡牌"记录
4. 玩家标记为"已胡"状态
5. **不打牌，回合直接结束**
6. **轮到下一个玩家**

**要点**：
- 胡牌后不打牌，回合立即结束
- 胡的牌单独记录，不再参与后续游戏（但会影响手牌数量）

---

### 4.5.4 操作对比表

| 动作 | 是否摸牌 | 是否打牌 | 回合归属 |
|------|---------|---------|---------|
| **碰牌** | ❌ 不摸 | ✅ 必须打 | 切换到碰牌者 |
| **明杠** | ✅ 补摸1张 | ✅ 必须打 | 切换到杠牌者 |
| **暗杠** | ✅ 补摸1张 | ✅ 必须打 | 保持不变 |
| **胡牌** | ❌ 不摸 | ❌ 不打 | 轮到下一个玩家 |

---

## 5. 血战流程
- 第一次胡牌后，玩家标记 `is_hu=True`，暗牌结构锁定：不得自行拆改已有面子或更换暗牌。
- 锁定状态仍照常轮到摸牌；所摸之牌必须在本回合立即打出，不能替换手中其他牌。若新摸的牌直接满足胡牌条件，可立即自摸胡牌；若他人打出可胡的牌，也可继续点炮。
- 允许一炮多响，系统按照 `胡 > 杠 > 碰 > 过` 的优先级处理多个响应。
- 牌局仅在牌墙摸完后结束，不设"三家胡自动收场"。
- **已胡玩家的限制**：
  - ✅ 可以继续摸牌和打牌
  - ✅ 可以再次胡牌（二次胡、三次胡...）
  - ❌ 不能碰牌（手牌已锁定）
  - ❌ 不能杠牌（手牌已锁定）
  - ⚠️  必须"摸什么打什么"（摸到的牌必须立即打出，不能打其他牌）

## 6. 胡牌结构与手牌张数

### 6.1 手牌数量规则（重要！）

**所有玩家在正常游戏中的手牌数量都相同：**

1. **发牌阶段**：
   - 庄家：14张
   - 闲家：13张

2. **埋牌后**：
   - 庄家：14 - 3 = **11张**
   - 闲家：13 - 3 = **10张**

3. **庄家第一次出牌后**：
   - 庄家：11 - 1 = **10张**
   - 闲家：**10张**

4. **之后所有玩家的正常循环**（包括庄家和闲家）：
   - **摸牌前**：10张
   - **摸牌后**：11张
   - **打牌后**：10张

**关键点**：
- ✅ 庄家的特殊性仅在于：发牌时多1张，第一个出牌，之后和闲家完全一样
- ✅ 所有玩家在游戏循环中都是"10张 → 摸牌 → 11张 → 打牌 → 10张"
- ❌ **绝对不会出现超过11张手牌的情况**（除非有bug）

### 6.2 胡牌结构

- **缺门限制**：胡牌时任何暗牌、明牌及埋牌都不得包含自己的缺门花色。
- **结构要求**：胡牌牌型需由"一对将 + 三个面子"组成，面子可以是顺子（同花色连续三张）、刻子（三张相同牌）或杠（四张相同牌）。

### 6.3 杠牌对手牌数量的影响

- 宣杠时：先将4张牌移至明牌区（暗牌 -4），随后补摸1张（暗牌 +1），净效果：暗牌 -3
- 例如：玩家有10张暗牌，杠牌后剩7张暗牌 + 1组杠（4张明牌）= 总共11张牌
- 杠牌后必须打牌，打牌后回到10张
- **因此，无论连续杠多少次，暗牌数量也不会超过11张**

## 7. 计分规则
- **番数即分数**：计算得到的总番数即为得分单位。点炮时由点炮者支付该番数，自摸时其余三家各支付该番数。
- **基础番**：达成胡牌结构即计 1 番，以下番型满足条件时在此基础上累加。

| 牌型名称 | 番数贡献 | 描述 |
|---|---|---|
| 基本胡 | 1 | 缺门成立且“一对将 + 三个面子”完整 |
| 门清 | +1 | 未碰、未执行明杠或补杠；暗杠不破坏门清 |
| 自摸 | +1 | 自己摸牌胡 |
| 带根（每根） | +1 | 每组四张同牌算一根 |
| 对对胡 | +1 | 由三副刻子/杠组成 |
| 清一色 | +2 | 所有牌同一花色 |
| 金钩钓 | +1 | 暗牌仅剩 1 张 |
| 清金钩钓 | +4 | 同时满足清一色与金钩钓 |
| 天胡 / 地胡 | +5 | 庄家埋牌后直接胡 / 闲家首轮摸牌即胡 |
| 杠上花 / 杠上炮 | +1 | 杠后立即胡 |
| 海底捞月 | +1 | 摸到牌墙最后一张胡 |

- **结算方式**：
  - **点炮**：点炮者支付胡牌番数；其他玩家不受影响。
  - **自摸**：其余三家按胡牌番数各自支付。
  - **杠分**：杠牌发生时即时结算（刮风下雨），计入双方分数。

## 8. 游戏结束与结算
- **结束条件**：游戏在牌墙摸完时结束，无论是否有玩家胡牌。
- **最终结算**：统计所有玩家的得分（包括胡牌得分和杠分），生成最终积分。杠分在发生时已即时结算（刮风下雨）。

## 9. 设计意图
- 以“番数即分数”替代指数倍数，降低记分复杂度。
- 通过冻结胡牌玩家手牌简化血战回合，同时允许持续宣胡，保持血战的高压氛围。
- 移除抢杠胡、查花猪、查大叫等难以实现且对单机体验影响有限的规则，便于后端快速实现与测试。
