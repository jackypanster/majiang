# FastAPI Backend - 血战到底麻将

FastAPI HTTP backend for Blood Battle Mahjong game.

## Quick Start

### 1. Run the Server

```bash
uv run uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 2. Access API Documentation

- Interactive API docs: http://localhost:8000/docs
- Alternative docs: http://localhost:8000/redoc
- Health check: http://localhost:8000/

### 3. Test the API

#### Create a Game
```bash
curl -X POST http://localhost:8000/games
```

#### Query Game State
```bash
curl "http://localhost:8000/games/{GAME_ID}?player_id=human"
```

#### Submit Action (Bury Cards)
```bash
curl -X POST http://localhost:8000/games/{GAME_ID}/action \
  -H "Content-Type: application/json" \
  -d '{
    "player_id": "human",
    "action": "bury",
    "tiles": [
      {"suit": "TONG", "rank": 1},
      {"suit": "TONG", "rank": 2},
      {"suit": "TONG", "rank": 3}
    ]
  }'
```

## Running Tests

```bash
# Run all tests
PYTHONPATH=. uv run pytest tests/ -v

# Run only API tests
PYTHONPATH=. uv run pytest tests/api/ -v

# Run only unit tests
uv run pytest tests/unit/ -v
```

## Project Structure

```
app/
├── main.py          # FastAPI app + GAMES storage + cleanup task
├── api.py           # Route handlers (create_game, get_game_state, submit_action)
├── ai.py            # AI decision logic (choose_bury_tiles, choose_discard_tile, choose_response)
├── models.py        # GameSession dataclass
├── schemas.py       # Pydantic request/response models
└── converters.py    # TileInput → Tile conversion

tests/api/           # Integration tests using TestClient
```

## API Endpoints

### `POST /games`
Create a new game session with 4 players (1 human + 3 AI).

**Response:**
```json
{
  "game_id": "a1b2c3d4",
  "state": {
    "game_phase": "BURYING",
    "current_player_index": 0,
    "players": [...],
    ...
  }
}
```

### `GET /games/{game_id}?player_id={player_id}`
Query game state filtered for specific player.

### `POST /games/{game_id}/action`
Submit player action and automatically execute AI turns.

**Actions:** `bury`, `discard`, `peng`, `gang`, `hu`, `skip`

## Features

- ✅ Automatic AI turn execution (with 5-second timeout)
- ✅ Automatic game cleanup (immediate on game end + periodic for 24h+ games)
- ✅ Player-specific state filtering (only show hand to owner)
- ✅ Blood Battle Mahjong rules implementation
- ✅ 108 unit tests + 6 integration tests

## Development

```bash
# Install dependencies
uv pip install fastapi "uvicorn[standard]" httpx pytest-asyncio

# Format code
uv run ruff format .

# Check code quality
uv run ruff check .
```

## Notes

- Game IDs are 8-character hex strings (generated by GameManager)
- All game state is stored in-memory (no database)
- AI executes synchronously during action requests
- Games are automatically cleaned up after 24 hours or when ended
