# 功能规格: 血战到底麻将 - 后端服务

**功能分支**: `001-backend-logic`  
**创建日期**: 2025-11-05  
**状态**: 草稿  
**输入**: 用户描述: "用 python 实现后端逻辑 @docs/PRD.md , 目前不要考虑前端图形化"

## Clarifications

### Session 2025-11-05
- Q: 从 `BURYING`（埋牌阶段）到 `PLAYING`（游戏进行中）的阶段转换，具体是由什么事件或条件触发的？ → A: 所有玩家完成埋牌
- Q: 当一局游戏因流局而结束后，下一局的庄家是谁？ → A: 庄家轮换
- Q: “带根”的番数是在杠牌发生时立即计算并影响当前胡牌的番数，还是在最终胡牌时才计算？ → A: 胡牌时计算
- Q: 在流局时，“花猪”的罚分和“未听牌者”向“听牌者”的赔付，具体是由谁向谁支付？ → A: 花猪/未听牌者向听牌者/胡牌者支付
- Q: 牌型中“带根”的具体定义是什么？它是否特指“暗杠”或“明杠”，还是包括了“暗刻”？ → A: 指四张相同的牌

## 用户场景与测试 *(强制)*

### 用户故事 1 - 游戏准备与开局 (优先级: P1)

作为游戏组织者，系统能够创建一个新的四人麻将游戏房间。玩家加入后，系统为庄家发14张牌，为闲家发13张牌。随后，每位玩家都能根据手牌选择一门缺门花色，并埋下三张该花色的牌，之后游戏正式开始。

**优先级原因**: 这是启动一局游戏的必要流程，是所有后续玩法的基础。

**独立测试**: 可以通过调用 `create_game` 和 `start_game` API，并为所有玩家调用 `bury_cards` API来独立测试此功能。成功后，应能通过 `get_game_state` 验证游戏已进入“游戏进行中”阶段，且每位玩家的手牌和缺门状态正确。

**验收场景**:

1.  **鉴于** 一个新游戏已创建并有4名玩家，**当** 游戏开始时，**那么** 庄家应收到14张牌，其他三家闲家各收到13张牌。
2.  **鉴于** 玩家已收到初始手牌，**当** 玩家选择一门花色并提交三张同花色的牌进行埋牌时，**那么** 系统应记录该玩家的缺门，并将其手牌更新为10张（闲家）或11张（庄家）。
3.  **鉴于** 所有玩家都已完成埋牌，**那么** 游戏状态应变为“PLAYING”，并轮到庄家出牌。

---

### 用户故事 2 - 核心游戏循环 (优先级: P2)

在游戏进行中，当前轮次的玩家可以打出一张牌。其他三名玩家在5秒的响应窗口内，可以根据自己的手牌和该弃牌，声明“碰”、“杠”、“胡”或“过”。系统根据“胡 > 杠 > 碰”的优先级来裁定动作的有效性并更新游戏状态。

**优先级原因**: 这是游戏的核心玩法，包含了最主要的用户交互和规则判断。

**独立测试**: 在一个已开局的游戏中，模拟一个玩家出牌。然后模拟其他一个或多个玩家在响应窗口内提交不同优先级的动作。验证系统是否总是正确地执行了最高优先级的动作。

**验收场景**:

1.  **鉴于** 轮到玩家A出牌，**当** 玩家A打出一张“五万”时，**那么** 其他三位玩家会收到该事件通知，并开启一个5秒的响应窗口。
2.  **鉴于** 玩家A打出“五万”，玩家B声明“碰”，玩家C声明“胡”，**当** 响应窗口关闭时，**那么** 系统应判定玩家C胡牌成功，游戏状态随之更新。
3.  **鉴于** 玩家A打出“五万”，没有任何玩家在5秒内响应，**那么** 系统应自动为所有玩家执行“过”，并轮到下一位玩家摸牌。

---

### 用户故事 3 - 游戏结束与结算 (优先级: P3)

当有玩家胡牌后，该玩家的积分被结算，但游戏继续（血战到底），直到有三家胡牌或牌墙被摸完（流局）。游戏最终结束时，系统会根据番型、杠牌、以及流局规则（查花猪、查大叫）为所有玩家进行最终计分。

**优先级原因**: 定义了游戏的胜利条件和最终得分计算，是游戏完整闭环的终点。

**独立测试**: 可以通过API强制设定特定的手牌组合和游戏状态，然后触发胡牌或流局事件。验证 `end_game` 后的结算结果是否与规则定义的计分方式完全一致。

**验收场景**:

1.  **鉴于** 玩家A打出一张牌，玩家B声明“胡”并满足胡牌条件，**那么** 玩家B的状态变为“已胡牌”，其得分被计算，但游戏继续进行。
2.  **鉴于** 牌墙的牌已被摸完，但只有两家胡牌，**那么** 游戏进入流局结算阶段，系统开始检查未胡牌玩家的“花猪”和“大叫”情况，并进行相应的赔付。
3.  **鉴于** 游戏正常结束（三家胡牌），**那么** 系统应根据每个玩家的胡牌番型、杠牌得分、点炮关系等，计算出最终的得分。

### 边缘场景

-   **无效操作**: 系统如何处理玩家提交的无效动作（例如，出一张不存在的牌，或者在不满足条件时声明“碰”）？ -> 系统必须拒绝该动作并抛出异常。
-   **一炮多响**: 如果一个玩家打出的牌让多个玩家可以同时胡牌，所有符合条件的玩家都将胡牌。点炮的玩家需要向每一位胡牌者支付相应的分数。
-   **调用时序**: 本服务是一个纯粹的游戏逻辑引擎，不管理玩家连接或超时。调用方（客户端）负责在正确的时机提交玩家动作。如果调用方在错误的时间或以错误的状态调用API，系统将直接抛出异常。

## 需求 *(强制)*

### 功能性需求

-   **FR-001**: 系统必须能创建一个四人玩家的“血战到底”麻将游戏。
-   **FR-002**: 系统必须在游戏开始时为庄家发14张牌，闲家13张。
-   **FR-003**: 系统必须强制玩家在开局时选择一个缺门并埋下三张同花色的牌。
-   **FR-004**: 系统必须支持玩家执行“出牌”、“碰”、“杠”（明杠、暗杠、补杠）、“胡”和“过”操作。
-   **FR-005**: 系统必须在有玩家出牌后，为其他玩家提供一个5秒的响应窗口，超时则默认为“过”。
-   **FR-006**: 系统必须按照 `胡 > 杠 > 碰` 的优先级来处理多个玩家的响应。
-   **FR-007**: 系统必须严格根据PRD中定义的胡牌条件（缺门、一对将+三个面子）来判断是否胡牌。
-   **FR-008**: 系统必须能根据PRD中定义的番型和计分公式准确计算得分，其中“带根”番数仅在胡牌时计算，且“带根”定义为牌型中包含四张相同的牌（无论其形成方式是杠牌还是暗刻）。
-   **FR-009**: 系统必须在发生杠牌时，即时结算“刮风下雨”的分数。
-   **FR-010**: 系统必须在牌墙摸完后，正确处理流局逻辑，包括“查花猪”和“查大叫”，其中花猪玩家向所有听牌或已胡牌的玩家支付罚分，未听牌者向所有听牌者支付赔付。
-   **FR-011**: 系统必须提供API接口以管理游戏生命周期 (`create_game`, `start_game`, `end_game`) 和处理玩家动作 (`discard_tile`, `declare_action` 等)。
-   **FR-012**: 系统的 `get_game_state` 接口必须对信息进行过滤，确保玩家只能看到自己的手牌。
-   **FR-013**: 系统必须在所有四名玩家都成功完成埋牌操作后，自动将游戏阶段 (`game_phase`) 从 `BURYING` 转换为 `PLAYING`。
-   **FR-014**: 在游戏流局结束后，下一局的庄家必须按照座位顺序轮换到当前庄家的下一位玩家。

### 关键实体

-   **`GameState`**: 描述游戏全局状态，包括当前玩家、牌墙剩余张数、游戏阶段等。
-   **`Player`**: 描述单个玩家的状态，包括手牌、明牌（碰/杠）、埋牌、缺门花色、得分和是否已胡牌。
-   **`Tile`**: 描述一张麻将牌，包含花色（筒、条、万）和点数（1-9）。

## 成功标准 *(强制)*

### 可衡量的成果

-   **SC-001**: 系统能够无错地完成一局完整的四人游戏，从创建到最终结算，所有规则判断和计分结果100%符合PRD的定义。
-   **SC-002**: 玩家的任何有效动作（出牌、碰、杠、胡）必须在500毫秒内反映到所有客户端的`GameState`中。
-   **SC-003**: 在模拟1000次并发响应（例如，三名玩家同时对一张牌做出响应）的压力测试下，系统对动作优先级的裁定准确率必须达到100%。
-   **SC-004**: 系统的计分模块在覆盖所有PRD中定义的番型的单元测试中，准确率必须为100%。

## 假设与范围

### 假设

-   客户端（如前端UI）负责渲染游戏状态和收集用户的输入。
-   所有玩家ID由外部系统提供，并保证在单局游戏内是唯一的。
-   网络延迟问题由基础设施负责，不属于本后端服务的逻辑范畴。

### 范围之外

-   AI 玩家或任何形式的机器人托管。
-   用户认证、账户管理或登录系统。
-   游戏状态的数据持久化（服务重启后游戏状态将丢失）。
-   任何前端UI的实现。
-   玩家连接、断线或操作超时的管理。本服务为本地逻辑引擎，依赖调用方管理游戏流程。