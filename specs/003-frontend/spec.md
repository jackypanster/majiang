# Feature Specification: 血战到底麻将前端界面

**Feature Branch**: `001-frontend`
**Created**: 2025-11-07
**Status**: Draft
**Input**: User description: "血战到底麻将前端架构 - React + Vite + Canvas 实现"

## Clarifications

### Session 2025-11-07

- Q: How should the UI respond when the browser window is resized? → A: 固定最小分辨率（如1280x720），窗口小于此尺寸时显示"请调整窗口大小"提示，不渲染游戏界面
- Q: When network requests fail during gameplay, what should happen? → A: 立即显示错误提示，游戏状态保持不变，仅提供"重试"按钮，用户手动点击重试（单机游戏，前后端在同一PC，网络错误通常是后端服务异常）
- Q: When action buttons (碰/杠/胡/过) are displayed, is there a time limit for the player to respond? → A: 无超时限制，玩家可以无限时间思考，直到点击任意按钮
- Q: How long should the win result dialog be displayed, and how does it close? → A: 模态弹窗显示结果，自动停留3秒后需要玩家点击"确认"按钮关闭
- Q: How should the discard pile be visually organized? → A: 最新的牌位于弃牌堆最上层（按时间倒序堆叠），且高亮显示（如黄色边框）

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 开始新游戏并完成定缺埋牌 (Priority: P1)

玩家打开游戏界面，点击"开始游戏"按钮，系统发牌后玩家能看到自己的13张手牌（或庄家14张），从中选择3张同花色的牌进行埋牌定缺，确认后进入正式游戏阶段。

**Why this priority**: 这是游戏的启动流程，是所有后续功能的基础。没有这个功能，游戏无法开始。

**Independent Test**: 可以通过点击"开始游戏"按钮，验证是否正确显示手牌、是否能选中3张同花色牌、是否能成功提交埋牌来独立测试此功能。

**Acceptance Scenarios**:

1. **Given** 玩家首次进入游戏界面，**When** 点击"开始游戏"按钮，**Then** 系统显示玩家的手牌（13或14张），界面提示"请选择3张同花色的牌进行埋牌"
2. **Given** 玩家看到自己的手牌，**When** 点击选中3张同花色的牌，**Then** 被选中的牌视觉上突出显示（向上浮起或高亮）
3. **Given** 玩家已选中3张同花色的牌，**When** 点击"确认埋牌"按钮，**Then** 系统接受埋牌，显示玩家的缺门花色，游戏阶段变为"游戏中"
4. **Given** 玩家尝试选择非同花色的牌，**When** 点击"确认埋牌"按钮，**Then** 系统显示错误提示"必须选择3张同花色的牌"

---

### User Story 2 - 出牌并观察AI响应 (Priority: P1)

在游戏进行中，轮到玩家回合时，玩家点击手牌中的一张牌进行出牌，系统将牌加入弃牌堆，并自动推进AI玩家的回合，玩家能实时看到AI的出牌动作和弃牌堆的变化。

**Why this priority**: 这是游戏的核心交互循环，玩家与AI的基本对局流程。没有这个功能，游戏无法进行。

**Independent Test**: 可以通过在玩家回合点击手牌、验证牌是否加入弃牌堆、观察AI是否自动出牌来独立测试此功能。

**Acceptance Scenarios**:

1. **Given** 轮到玩家回合且手中有缺门牌，**When** 玩家点击缺门牌，**Then** 该牌被打出并显示在弃牌堆中央，当前回合切换至下家AI
2. **Given** 轮到玩家回合且手中无缺门牌，**When** 玩家点击任意手牌，**Then** 该牌被打出并显示在弃牌堆中央
3. **Given** 玩家打出一张牌后轮到AI，**When** AI自动执行出牌逻辑（500ms内），**Then** 前端通过轮询检测到AI的出牌，更新弃牌堆和AI手牌数量显示
4. **Given** AI连续出牌，**When** 轮回到玩家回合，**Then** 界面停止轮询，等待玩家点击出牌

---

### User Story 3 - 响应碰牌/杠牌/胡牌操作 (Priority: P1)

当AI或其他玩家打出一张牌时，如果玩家可以碰、杠或胡，系统在界面上显示对应的操作按钮（碰/杠/胡/过），玩家点击按钮后执行相应动作，游戏状态实时更新。

**Why this priority**: 这是血战到底麻将的核心玩法机制，玩家需要能够响应他人的出牌来形成明牌组合或胡牌。

**Independent Test**: 可以通过构造特定手牌（如有两张相同的牌），等待AI打出第三张相同的牌，验证是否显示"碰"按钮，点击后是否正确形成明牌。

**Acceptance Scenarios**:

1. **Given** AI打出一张牌且玩家手中有两张相同的牌可以碰，**When** 后端返回 `availableActions: ['PONG', 'PASS']`，**Then** 界面显示"碰"和"过"按钮，无时间限制，等待玩家点击任意按钮
2. **Given** 界面显示"碰"按钮，**When** 玩家点击"碰"，**Then** 系统执行碰牌操作，将3张相同的牌从手牌移动到明牌区域，当前回合变为玩家，等待玩家出牌
3. **Given** AI打出一张牌且玩家可以胡，**When** 后端返回 `availableActions: ['HU', 'PASS']`，**Then** 界面显示"胡"和"过"按钮，"胡"按钮高亮显示
4. **Given** 玩家点击"胡"按钮，**When** 系统确认胡牌成功，**Then** 界面显示模态弹窗展示胡牌结果（番数、得分变化），自动停留3秒后"确认"按钮变为可点击状态，玩家点击后关闭弹窗，游戏进入结束或血战继续状态
5. **Given** 玩家可以响应且操作按钮已显示，**When** 玩家思考时间超过任意时长，**Then** 系统不进行超时处理，继续等待玩家点击

---

### User Story 4 - 查看游戏信息和状态 (Priority: P2)

玩家在游戏过程中，能够随时查看当前的游戏信息，包括：当前回合是谁、牌墙剩余数量、各玩家的明牌、各玩家的得分、弃牌堆历史等。

**Why this priority**: 这些信息帮助玩家做出战术决策，提升游戏体验，但不影响基本游戏流程。

**Independent Test**: 可以通过观察界面上的信息栏、明牌区域、弃牌堆显示，验证数据是否与后端状态一致。

**Acceptance Scenarios**:

1. **Given** 游戏进行中，**When** 玩家查看界面右上角的信息栏，**Then** 显示当前回合玩家（如"轮到：AI 1"）、牌墙剩余数量（如"剩余：42张"）
2. **Given** AI玩家已有明牌（碰或杠），**When** 玩家查看AI玩家区域，**Then** 明牌以正面形式展示（显示花色和点数）
3. **Given** 游戏进行多轮，**When** 玩家查看弃牌堆，**Then** 弃牌按时间倒序堆叠显示（最新的牌位于最上层），最新打出的牌带有黄色高亮边框

---

### User Story 5 - 血战模式继续游戏 (Priority: P2)

在血战到底模式下，玩家第一次胡牌后，游戏不结束，玩家继续参与游戏但手牌锁定（只能"摸什么打什么"），可以继续自摸或点炮累计番数，直到牌墙摸完或满3家胡牌。

**Why this priority**: 这是"血战到底"的特色玩法，是MVP的核心卖点之一，但技术上是在基本胡牌逻辑之上的扩展。

**Independent Test**: 可以通过构造玩家胡牌场景，验证胡牌后游戏是否继续、手牌是否锁定、是否能继续胡牌。

**Acceptance Scenarios**:

1. **Given** 玩家第一次胡牌（自摸或点炮），**When** 胡牌结算完成，**Then** 界面显示模态弹窗展示胡牌结果和"血战继续"提示（自动停留3秒后可点击"确认"），玩家确认后手牌区域标记"已锁定"，游戏继续
2. **Given** 玩家手牌已锁定，**When** 轮到玩家回合，**Then** 玩家只能点击最新摸到的牌进行出牌，无法选择其他暗牌
3. **Given** 玩家已胡牌一次且手牌锁定，**When** 玩家再次满足胡牌条件（自摸或点炮），**Then** 界面显示"再次胡牌"，累计番数更新，游戏继续或结束（根据规则）

---

### User Story 6 - 使用Canvas渲染麻将牌 (Priority: P3)

玩家在游戏中看到的麻将牌不是简单的文字显示（如"万1"），而是通过Canvas绘制的程序化图形，包括矩形、渐变、花色文字等，呈现出真实麻将牌的视觉效果。

**Why this priority**: 这是视觉体验的提升，但对MVP功能验证不是必需的。可以先用文字显示完成功能开发，后期再替换为Canvas渲染。

**Independent Test**: 可以通过观察手牌区域的渲染方式，验证是否使用Canvas元素绘制，是否正确显示花色和点数。

**Acceptance Scenarios**:

1. **Given** 游戏开始发牌，**When** 玩家手牌区域渲染完成，**Then** 每张牌显示为Canvas绘制的矩形，带有渐变背景和居中的花色文字（如"🀇"万1）
2. **Given** 玩家点击手牌，**When** 牌被选中或高亮，**Then** Canvas重绘该牌，添加高亮边框或向上浮起动画
3. **Given** AI玩家的手牌，**When** 渲染AI手牌区域，**Then** 显示为牌背（Canvas绘制的纯色矩形），数量与后端一致

---

### Edge Cases

- **当后端API请求失败时（如后端服务停止或端口占用）**：游戏状态保持不变，界面立即显示"后端服务连接失败，请确认后端服务正在运行"提示，提供"重试"按钮，用户手动点击后重新发起请求
- **当玩家在埋牌阶段选择了3张非同花色的牌时**：点击"确认埋牌"应显示错误提示，不允许提交
- **当玩家手中有缺门牌但尝试打出非缺门牌时**：前端应在点击前进行校验，禁止点击非缺门牌或显示提示"请先打出缺门牌"
- **当多个AI玩家同时可以响应（碰/杠/胡）时**：后端返回的 `availableActions` 仅针对真人玩家，AI的响应由后端自动处理，前端只需显示玩家自己的可用动作
- **当游戏结束时（流局或满3家胡牌）**：界面显示最终得分榜，提供"再来一局"按钮，点击后重新创建游戏
- **当浏览器窗口小于最小分辨率时**：界面应显示"请调整窗口大小至至少1280x720以获得最佳体验"提示，不渲染游戏界面
- **当玩家快速连续点击出牌时**：应防止重复提交，第一次点击后禁用手牌点击，直到后端响应完成

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须提供"开始游戏"按钮，点击后调用后端API创建游戏并发牌，显示玩家手牌
- **FR-002**: 系统必须在埋牌阶段允许玩家选择3张手牌，被选中的牌视觉上高亮显示（向上浮起或边框高亮）
- **FR-003**: 系统必须验证埋牌时选中的3张牌是否同花色，不同花色则显示错误提示"必须选择3张同花色的牌"
- **FR-004**: 系统必须在游戏进行阶段显示玩家手牌、AI玩家区域（显示手牌数量和明牌）、弃牌堆、游戏信息栏
- **FR-005**: 系统必须允许玩家点击手牌进行出牌，点击后调用后端API执行出牌动作
- **FR-006**: 系统必须在玩家回合优先允许打出缺门花色的牌，若手中无缺门牌则可打任意牌
- **FR-007**: 系统必须在非玩家回合时（AI回合）通过轮询后端API（500ms间隔）获取最新游戏状态，并更新界面显示
- **FR-008**: 系统必须在检测到玩家可以碰/杠/胡时，显示对应的操作按钮（碰/杠/胡/过），无超时限制，等待玩家点击后调用后端API执行动作
- **FR-009**: 系统必须在玩家执行碰牌后，将3张相同的牌从手牌区域移动到明牌区域显示
- **FR-010**: 系统必须在玩家胡牌后，显示模态弹窗展示胡牌结果（番数、得分变化、是否血战继续），弹窗自动停留3秒后"确认"按钮变为可点击状态，玩家点击"确认"后关闭弹窗
- **FR-011**: 系统必须在血战模式下，玩家第一次胡牌后标记手牌为"已锁定"状态，只允许打出最新摸到的牌
- **FR-012**: 系统必须在游戏结束时（流局或满3家胡牌），显示最终得分榜，并提供"再来一局"按钮
- **FR-013**: 系统必须显示实时游戏信息，包括当前回合玩家、牌墙剩余数量、各玩家得分
- **FR-014**: 系统必须在弃牌堆中按时间倒序堆叠显示所有已打出的牌（最新的牌位于最上层），最新的牌必须添加黄色高亮边框以区分
- **FR-015**: 系统必须使用Canvas绘制麻将牌（程序化绘制矩形、渐变、文字），而非依赖外部图片资源
- **FR-016**: 系统必须在后端API请求失败时（如localhost连接失败、后端服务停止）立即显示错误提示，保持游戏状态不变，提供"重试"按钮供用户手动重试
- **FR-017**: 系统必须防止玩家在等待后端响应期间重复点击操作按钮或手牌
- **FR-018**: 系统必须在所有界面文案中使用中文，包括按钮文字、提示信息、错误消息
- **FR-019**: 系统必须检测浏览器窗口尺寸，当窗口小于1280x720时显示"请调整窗口大小"提示，阻止游戏渲染

### Key Entities

- **游戏会话（Game Session）**: 表示一局游戏的完整状态，包括游戏ID、当前阶段（初始化/埋牌/游戏中/结束）、当前回合玩家、庄家、牌墙剩余数量
- **玩家（Player）**: 包括真人玩家（ID=0）和AI玩家（ID=1-3），每个玩家有手牌、明牌、埋牌、缺门花色、得分、是否胡牌、手牌是否锁定等属性
- **麻将牌（Tile）**: 包含花色（万/条/筒）和点数（1-9），前端用唯一ID追踪每张牌
- **明牌组合（Meld）**: 表示碰牌或杠牌的组合，包含类型（碰/杠）和对应的麻将牌列表
- **弃牌堆（Discard Pile）**: 按打出顺序存储所有玩家打出的牌，用于显示历史记录和响应判断
- **可用动作（Available Actions）**: 当前玩家可以执行的操作类型（出牌/碰/杠/胡/过），由后端根据游戏规则计算

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 玩家从点击"开始游戏"到看到手牌并完成埋牌，整个流程在5秒内完成（不含网络延迟）
- **SC-002**: 玩家在游戏进行中点击出牌后，界面响应时间在100ms内（本地状态更新），后端同步在1秒内完成
- **SC-003**: AI回合期间，前端通过轮询在500ms内检测到状态变化并更新界面
- **SC-004**: 玩家能够在90%的情况下成功完成埋牌操作（选择3张同花色牌并确认）
- **SC-005**: 当玩家可以碰/杠/胡时，界面在500ms内显示对应操作按钮
- **SC-006**: 游戏结束时，最终得分榜在2秒内显示，数据与后端计算结果100%一致
- **SC-007**: Canvas渲染的麻将牌在1920x1080分辨率下清晰可辨认，无模糊或错位
- **SC-008**: 玩家在手牌锁定状态下，100%无法点击非最新摸牌的暗牌（前端校验生效）
- **SC-009**: 网络错误或后端异常时，界面在3秒内显示友好的错误提示，并提供重试选项
- **SC-010**: 单局游戏从开始到结束（假设20轮出牌），前端无内存泄漏，Canvas渲染帧率保持在30fps以上

## Dependencies & Assumptions *(optional)*

### Dependencies

- **后端API**: 前端完全依赖后端提供的3个REST端点（POST /games, GET /games/{id}, POST /games/{id}/action），后端需先完成开发并可用
- **浏览器支持**: 依赖现代浏览器的Canvas 2D API、Fetch API、ES6+语法支持（Chrome 90+, Firefox 88+, Safari 14+）
- **开发工具链**: 依赖Node.js 18+、npm或yarn包管理器、Vite构建工具

### Assumptions

- **单机模式**: 假设游戏仅支持本机调试，不考虑多设备同步、持久化存储、用户认证等功能
- **AI即时响应**: 假设后端AI决策逻辑在500ms内完成，前端通过轮询能及时获取AI的出牌结果
- **网络环境**: 假设开发和测试环境网络延迟低于100ms，后端API响应时间在1秒内
- **Canvas渲染性能**: 假设麻将牌数量（最多14张手牌 + 若干明牌 + 弃牌堆）在Canvas上绘制不会导致性能问题
- **数据一致性**: 假设后端返回的游戏状态数据始终正确，前端不需要额外校验数据有效性（除埋牌同花色校验）
- **中文环境**: 假设所有用户使用中文界面，不需要国际化（i18n）支持
- **固定玩家数量**: 假设游戏始终为1真人 + 3AI的4人模式，不支持2人或3人模式

## Out of Scope *(optional)*

以下功能明确不在本次MVP范围内：

- **多人联机对战**: 不支持多个真人玩家通过网络对战，仅支持1真人 + 3AI
- **用户系统**: 不包含用户注册、登录、个人资料、历史战绩等功能
- **持久化存储**: 不保存游戏进度或历史记录到数据库，游戏状态仅存在于后端进程内存中
- **高级动画效果**: 不包含3D渲染、粒子效果、复杂过渡动画，仅基本的Canvas 2D绘制和简单CSS动画
- **音效与背景音乐**: 不包含游戏音效或背景音乐
- **移动端适配**: 不针对移动设备（手机/平板）进行UI适配或触摸优化，仅支持桌面浏览器
- **AI难度调节**: AI策略固定，不提供难度选择（简单/中等/困难）
- **复盘功能**: 不支持游戏结束后回放每一步操作
- **聊天或表情**: 不支持玩家与AI的聊天或发送表情
- **自定义规则**: 不支持玩家自定义游戏规则（如改变番数计算方式、是否允许杠牌等）
